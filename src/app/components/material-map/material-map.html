<div class="map-container">
  <div id="map"></div>

  <!-- Loading Overlay -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <div class="loading-spinner"></div>
      <p>Loading materials data...</p>
    </div>
  }

  <!-- Map Not Initialized Warning -->
  @if (!mapInitialized() && !isLoading()) {
    <div class="error-overlay">
      <div class="error-icon">ğŸ—ºï¸</div>
      <h3>Map Not Loaded</h3>
      <p>The map could not be initialized. Please check the browser console for errors.</p>
      <button class="retry-btn" (click)="initMap()">Retry Map</button>
    </div>
  }

  <!-- API Error Notice -->
  @if (hasError() && !isLoading()) {
    <div class="api-error-notice">
      <div class="error-icon">âš ï¸</div>
      <div class="error-content">
        <h4>Connection Issue</h4>
        <p>Unable to load materials data. Please check your connection.</p>
        <button class="retry-btn-small" (click)="retryLoadMaterials()">Retry Connection</button>
      </div>
    </div>
  }

  <!-- Controls Panel -->
  @if (materials().length > 0 && mapInitialized()) {
    <div class="controls-panel">
      <h3>Filter Materials</h3>
      
      <div class="filter-group">
        <label for="materialFilter">Material Name</label>
        <input 
          id="materialFilter" 
          type="text" 
          placeholder="Search materials..."
          [value]="filters().material"
          (input)="onFilterChange('material', $any($event.target).value)">
      </div>

      <div class="filter-group">
        <label for="typeFilter">Material Type</label>
        <select 
          id="typeFilter" 
          [value]="filters().type"
          (change)="onFilterChange('type', $any($event.target).value)">
          <option value="">All Types</option>
          <option value="Blocks">ğŸ§± Blocks</option>
          <option value="Bricks">ğŸ§± Bricks</option>
          <option value="Sand">ğŸ–ï¸ Sand</option>
          <option value="Stones">ğŸª¨ Stones</option>
          <option value="Limestone">ğŸª¨ Limestone</option>
          <option value="Wood">ğŸªµ Wood/Timber</option>
          <option value="Cement">ğŸ—ï¸ Cement</option>
          <option value="Concrete">ğŸ—ï¸ Concrete</option>
          <option value="Metal">âš™ï¸ Metal</option>
          <option value="Glass">ğŸ”² Glass</option>
          <option value="Makuti">ğŸŒ´ Makuti</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="regionFilter">Region</label>
        <select 
          id="regionFilter" 
          [value]="filters().region"
          (change)="onFilterChange('region', $any($event.target).value)">
          <option value="">All Regions</option>
          <option value="Mombasa">Mombasa</option>
        </select>
      </div>

      <div class="filter-buttons">
        <button class="apply-btn" (click)="applyFilters()">Apply Filters</button>
        <button class="clear-btn" (click)="clearFilters()">Clear All</button>
      </div>

      <!-- Materials Count -->
      <div class="materials-count">
        Showing {{ filteredMaterials().length }} of {{ materials().length }} materials
      </div>

      <!-- Legend -->
      <div class="legend">
        <h4>Material Icons</h4>
        <div class="legend-item">
          <span class="legend-icon">ğŸ§±</span>
          <span>Blocks/Bricks</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon">ğŸ–ï¸</span>
          <span>Sand</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon">ğŸª¨</span>
          <span>Stones</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon">ğŸ—ï¸</span>
          <span>Cement/Concrete</span>
        </div>
        <div class="legend-item">
          <span class="legend-icon">ğŸªµ</span>
          <span>Wood/Timber</span>
        </div>
      </div>
    </div>
  }

  <!-- No Data Message -->
  @if (!isLoading() && !hasError() && materials().length === 0 && mapInitialized()) {
    <div class="no-data-message">
      <div class="no-data-icon">ğŸ“Š</div>
      <h3>No Materials Data</h3>
      <p>No materials data available to display.</p>
    </div>
  }

  <!-- Material Details Panel -->
  @if (selectedMaterial(); as material) {
    <div class="material-details">
      <div class="material-header">
        <span class="material-icon-large">{{ material.icon || 'ğŸ“¦' }}</span>
        <h3>{{ material.name }}</h3>
      </div>
      
      <div class="detail-section">
        <h4>Location Information</h4>
        <p><strong>Location:</strong> {{ material.location.name }}</p>
        <p><strong>County:</strong> {{ material.location.county }}</p>
        <p><strong>Sub-County:</strong> {{ material.location.subCounty }}</p>
        <p><strong>Ward:</strong> {{ material.location.ward }}</p>
        <p><strong>Coordinates:</strong> {{ material.location.latitude | number:'1.4-4' }}, {{ material.location.longitude | number:'1.4-4' }}</p>
      </div>

      <div class="detail-section">
        <h4>Material Types</h4>
        <div class="material-types">
          @for (type of material.type; track type) {
            <span class="material-type-badge">
              {{ getTypeIcon(type) }} {{ type }}
            </span>
          }
        </div>
      </div>

      <div class="detail-section">
        <h4>Research Details</h4>
        <p><strong>Questionnaire No:</strong> {{ material.questionnaireNo }}</p>
        <p><strong>Research Assistant:</strong> {{ material.researchAssistantNo }}</p>
        @if (material.timestamp) {
          <p><strong>Recorded:</strong> {{ material.timestamp | date:'medium' }}</p>
        }
      </div>

      <div class="detail-section">
        <h4>Production Details</h4>
        <p><strong>Industry Size:</strong> {{ material.sizeOfManufacturingIndustry }}</p>
        <p><strong>Period of Manufacture:</strong> {{ material.periodOfManufacture }}</p>
        <p><strong>Owner:</strong> {{ material.ownerOfMaterial }}</p>
        <p><strong>Usage:</strong> {{ material.materialUsage }}</p>
        <p><strong>Employees:</strong> {{ material.numberOfPeopleEmployed }}</p>
        <p><strong>Daily Production:</strong> {{ material.volumeProducedPerDay }}</p>
        <p><strong>Used In:</strong> {{ material.materialUsedIn }}</p>
        @if (material.similarLocations) {
          <p><strong>Similar Locations:</strong> {{ material.similarLocations }}</p>
        }
      </div>

      @if (material.challenges && material.challenges.length > 0) {
        <div class="detail-section">
          <h4>Challenges</h4>
          <ul>
            @for (challenge of material.challenges; track challenge) {
              <li>{{ challenge }}</li>
            }
          </ul>
        </div>
      }

      @if (material.comments) {
        <div class="detail-section">
          <h4>Comments</h4>
          <p>{{ material.comments }}</p>
        </div>
      }
    </div>
  }
</div>